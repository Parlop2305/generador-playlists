<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Playlist en YouTube</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button { margin: 10px 0; padding: 10px; font-size: 16px; width: 100%; }
    #playlistLink { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>üéµ Generador de Playlist (YouTube)</h1>

  <label>Algoritmo:</label>
  <select id="algorithm">
    <option value="content">üéØ Basado en contenido</option>
    <option value="collaborative">üßë‚Äçü§ù‚Äçüßë Colaborativo simulado</option>
    <option value="random">üé≤ Popularidad + aleatorio</option>
  </select>

  <label>Estado de √°nimo:</label>
  <select id="mood">
    <option value="Relax">Relax</option>
    <option value="Energ√≠a">Energ√≠a</option>
    <option value="Tristeza">Tristeza</option>
    <option value="Felicidad">Felicidad</option>
  </select>

  <label>Artista favorito:</label>
  <input type="text" id="artist" placeholder="Ej: Adele">

  <label>G√©nero musical:</label>
  <select id="genre">
    <option value="Pop">Pop</option>
    <option value="Rock">Rock</option>
    <option value="Electr√≥nica">Electr√≥nica</option>
    <option value="Latino">Latino</option>
  </select>

  <button id="authBtn">üîë Iniciar sesi√≥n con Google</button>
  <button id="generateBtn" disabled>üé∂ Crear Playlist</button>

  <div id="playlistLink"></div>

  <script>
    let accessToken = null;

    const CLIENT_ID = '743111186567-mfqinhq9np4q2vdpe3otkrboacquoqee.apps.googleusercontent.com';
    const REDIRECT_URI = window.location.origin;

    // Detecta el token
    window.onload = () => {
      const hash = window.location.hash;
      if (hash.includes('access_token')) {
        accessToken = new URLSearchParams(hash.replace('#', '?')).get('access_token');
        document.getElementById("generateBtn").disabled = false;
      }
    };

    document.getElementById("authBtn").onclick = () => {
      const scopes = 'https://www.googleapis.com/auth/youtube';
      const url =
        'https://accounts.google.com/o/oauth2/v2/auth' +
        '?client_id=' + CLIENT_ID +
        '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) +
        '&response_type=token' +
        '&scope=' + encodeURIComponent(scopes);
      window.location.href = url;
    };

    document.getElementById("generateBtn").onclick = async () => {
      const algorithm = document.getElementById("algorithm").value;
      const mood = document.getElementById("mood").value;
      const artist = document.getElementById("artist").value;
      const genre = document.getElementById("genre").value;

      let queries = [];

      if (algorithm === "content") {
        // Basado en contenido
        queries = [
          `${artist} ${genre} top songs`,
          `${genre} music for ${mood}`,
          `${artist} best of`
        ];
      } else if (algorithm === "collaborative") {
        // Simulaci√≥n colaborativa con perfiles ficticios
        const perfiles = {
          Sof√≠a: ["Adele", "Taylor Swift", "Lorde"],
          Carlos: ["Linkin Park", "Imagine Dragons", "Muse"],
          Mariana: ["Bad Bunny", "Karol G", "Rauw Alejandro"]
        };

        let match = Object.entries(perfiles).find(([_, artistas]) =>
          artistas.some(a => artist.toLowerCase().includes(a.toLowerCase()))
        );

        if (match) {
          queries = match[1].map(nombre => `${nombre} greatest hits`);
        } else {
          queries = [`${artist} popular songs`, `${genre} trending`];
        }
      } else if (algorithm === "random") {
        // Popularidad + aleatoriedad
        const a√±o = new Date().getFullYear();
        const randomExtras = ["mix", "live", "official"];
        const extra = randomExtras[Math.floor(Math.random() * randomExtras.length)];

        queries = [
          `Top trending music ${a√±o}`,
          `${genre} hits ${extra}`,
          `${mood} playlist ${a√±o}`
        ];
      }

      const videoIds = [];
      for (let query of queries) {
        const id = await searchVideo(query);
        if (id) videoIds.push(id);
      }

      const playlistTitle = `${algorithm.toUpperCase()} | ${artist} + ${genre} + ${mood}`;
      const playlistId = await createPlaylist(playlistTitle);
      await addVideosToPlaylist(playlistId, videoIds);

      document.getElementById("playlistLink").innerHTML =
        `‚úÖ Playlist creada: <a href="https://www.youtube.com/playlist?list=${playlistId}" target="_blank">Ver en YouTube</a>`;
    };

    async function searchVideo(query) {
      const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&maxResults=1`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const data = await res.json();
      return data.items?.[0]?.id?.videoId || null;
    }

    async function createPlaylist(title) {
      const res = await fetch('https://www.googleapis.com/youtube/v3/playlists?part=snippet,status', {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          snippet: {
            title: title,
            description: 'Playlist generada autom√°ticamente por algoritmo musical',
          },
          status: { privacyStatus: 'private' }
        })
      });
      const data = await res.json();
      return data.id;
    }

    async function addVideosToPlaylist(playlistId, videoIds) {
      for (let videoId of videoIds) {
        await fetch('https://www.googleapis.com/youtube/v3/playlistItems?part=snippet', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            snippet: {
              playlistId: playlistId,
              resourceId: {
                kind: "youtube#video",
                videoId: videoId
              }
            }
          })
        });
      }
    }
  </script>
</body>
</html>
