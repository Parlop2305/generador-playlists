<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Playlists</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button, input, select { padding: 10px; margin: 10px 0; width: 100%; font-size: 16px; }
    #playlistLink { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ðŸŽµ Generador de Playlist</h1>

  <label>Artista favorito:</label>
  <input type="text" id="artist" placeholder="Ej: Bad Bunny">

  <label>Algoritmo:</label>
  <select id="algorithm">
    <option value="content">ðŸŽ¯ Basado en contenido</option>
    <option value="collaborative">ðŸ§  Colaborativo simulado</option>
    <option value="random">ðŸŽ² Popularidad + aleatorio</option>
  </select>

  <button id="authBtn">ðŸ”‘ Iniciar sesiÃ³n con Google</button>
  <button id="spotifyBtn">ðŸŸ¢ Iniciar sesiÃ³n con Spotify</button>
  <button id="generateBtn" disabled>ðŸŽ¶ Crear Playlist (YouTube)</button>
  <button id="generateSpotifyBtn" disabled>ðŸŽ¶ Crear Playlist (Spotify)</button>

  <div id="playlistLink"></div>

  <script>
    const GOOGLE_CLIENT_ID = '743111186567-mfqinhq9np4q2vdpe3otkrboacquoqee.apps.googleusercontent.com';
    const GOOGLE_REDIRECT_URI = 'https://parlop2305.github.io/generador-playlists/';
    const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/youtube';
    const googleAuthURL =
      'https://accounts.google.com/o/oauth2/v2/auth' +
      '?client_id=' + GOOGLE_CLIENT_ID +
      '&redirect_uri=' + encodeURIComponent(GOOGLE_REDIRECT_URI) +
      '&response_type=token' +
      '&scope=' + encodeURIComponent(GOOGLE_SCOPES);

    const SPOTIFY_CLIENT_ID = '5e1d32a3e54b4fb1ba42be6b643162ea';
    const SPOTIFY_REDIRECT_URI = 'https://parlop2305.github.io/generador-playlists/';
    const SPOTIFY_SCOPES = [
      'playlist-modify-public',
      'playlist-modify-private',
      'user-read-private'
    ];
    const spotifyAuthURL =
      'https://accounts.spotify.com/authorize' +
      '?response_type=token' +
      '&client_id=' + SPOTIFY_CLIENT_ID +
      '&redirect_uri=' + encodeURIComponent(SPOTIFY_REDIRECT_URI) +
      '&scope=' + encodeURIComponent(SPOTIFY_SCOPES.join(' '));

    let googleToken = null;
    let spotifyToken = null;

    document.getElementById("authBtn").onclick = () => {
      localStorage.setItem("authSource", "google");
      window.location.href = googleAuthURL;
    };

    document.getElementById("spotifyBtn").onclick = () => {
      localStorage.setItem("authSource", "spotify");
      window.location.href = spotifyAuthURL;
    };

    window.addEventListener('load', function () {
      const hash = window.location.hash;
      if (hash.includes('access_token')) {
        const token = new URLSearchParams(hash.substring(1)).get('access_token');
        const source = localStorage.getItem("authSource");
        if (source === "google") {
          googleToken = token;
          document.getElementById("generateBtn").disabled = false;
        } else if (source === "spotify") {
          spotifyToken = token;
          document.getElementById("generateSpotifyBtn").disabled = false;
        }
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    });

    document.getElementById("generateSpotifyBtn").onclick = async () => {
      const artist = document.getElementById("artist").value;
      const algorithm = document.getElementById("algorithm").value;

      let queries = [];

      if (algorithm === "content") {
        queries = [
          `${artist} top hits`,
          `${artist} best songs`,
          `${artist} ${new Date().getFullYear()}`
        ];
      } else if (algorithm === "collaborative") {
        const perfiles = {
          SofÃ­a: ["Adele", "Taylor Swift", "Lorde"],
          Carlos: ["Linkin Park", "Imagine Dragons", "Muse"],
          Mariana: ["Bad Bunny", "Karol G", "Rauw Alejandro"]
        };
        let match = Object.entries(perfiles).find(([_, artistas]) =>
          artistas.some(a => artist.toLowerCase().includes(a.toLowerCase()))
        );
        queries = match
          ? match[1].map(a => `${a} best hits`)
          : [`${artist} playlist`, `${artist} best of`];
      } else if (algorithm === "random") {
        const aÃ±o = new Date().getFullYear();
        const extras = ["mix", "live", "official"];
        const extra = extras[Math.floor(Math.random() * extras.length)];
        queries = [
          `Top music ${aÃ±o}`,
          `${artist} ${extra}`,
          `Trending music ${aÃ±o}`
        ];
      }

      const trackUris = [];
      for (let q of queries) {
        const uri = await searchSpotifyTracks(q);
        if (uri) trackUris.push(uri);
      }

      const userId = await getSpotifyUserId();
      const playlistId = await createSpotifyPlaylist(userId, `Playlist (${algorithm}) - ${artist}`);
      await addTracksToSpotifyPlaylist(playlistId, trackUris);

      document.getElementById("playlistLink").innerHTML =
        `âœ… Playlist creada en Spotify: <a href="https://open.spotify.com/playlist/${playlistId}" target="_blank">Ver</a>`;
    };

    async function searchSpotifyTracks(query) {
      const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`, {
        headers: { Authorization: `Bearer ${spotifyToken}` }
      });
      const data = await res.json();
      return data.tracks?.items?.[0]?.uri || null;
    }

    async function getSpotifyUserId() {
      const res = await fetch('https://api.spotify.com/v1/me', {
        headers: { Authorization: `Bearer ${spotifyToken}` }
      });
      const data = await res.json();
      return data.id;
    }

    async function createSpotifyPlaylist(userId, name) {
      const res = await fetch(`https://api.spotify.com/v1/users/${userId}/playlists`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${spotifyToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: name,
          description: 'Generado automÃ¡ticamente',
          public: false
        })
      });
      const data = await res.json();
      return data.id;
    }

    async function addTracksToSpotifyPlaylist(playlistId, trackUris) {
      await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${spotifyToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ uris: trackUris })
      });
    }
  </script>
</body>
</html>
